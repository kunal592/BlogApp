// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================================
// USER MODEL
// =========================================
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  username  String?  @unique
  name      String?
  bio       String?  @db.Text
  avatar    String?
  role      Role     @default(USER)
  
  // Status
  isActive   Boolean  @default(true)
  isVerified Boolean  @default(false)
  
  // Social stats (denormalized for performance)
  followerCount  Int @default(0)
  followingCount Int @default(0)
  
  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete
  
  // Relations
  followers  Follow[]   @relation("following")
  following  Follow[]   @relation("follower")
  blogs      Blog[]     @relation("author")
  likes      Like[]
  bookmarks  Bookmark[]
  comments      Comment[]
  commentLikes  CommentLike[]
  purchases     Purchase[]
  notifications Notification[]
  wallet        Wallet?
  communityNotes CommunityNote[]
  noteVotes     NoteVote[]
  
  @@index([email])
  @@index([username])
  @@index([role])
  @@index([createdAt])
  @@map("users")
}

// =========================================
// FOLLOW MODEL (Social Graph)
// =========================================
model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  
  // Relations
  follower  User @relation("follower", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("following", fields: [followingId], references: [id], onDelete: Cascade)
  
  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}

// =========================================
// BLOG MODEL (Core Content)
// =========================================
model Blog {
  id          String     @id @default(cuid())
  slug        String     @unique
  title       String
  subtitle    String?
  content     String     @db.Text // Markdown content
  excerpt     String?    @db.Text // Short preview text
  coverImage  String?
  
  // Author
  authorId    String
  author      User       @relation("author", fields: [authorId], references: [id], onDelete: Cascade)
  
  // Status & Visibility
  status      BlogStatus @default(DRAFT)
  isExclusive Boolean    @default(false) // Paid content
  price       Int?       // Price in tokens (if exclusive)
  
  // SEO
  metaTitle       String?
  metaDescription String? @db.Text
  metaKeywords    String?
  canonicalUrl    String?
  ogImage         String?
  
  // AI-ready fields (will be populated by AI module)
  summary         String?  @db.Text // AI-generated summary
  readingTime     Int?     // Estimated reading time in minutes
  
  // Engagement stats (denormalized for performance)
  viewCount     Int @default(0)
  likeCount     Int @default(0)
  bookmarkCount Int @default(0)
  commentCount  Int @default(0)
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime? // When the blog was published
  deletedAt   DateTime? // Soft delete
  
  // Relations
  likes     Like[]
  bookmarks Bookmark[]
  tags      BlogTag[]
  media     Media[]    // Associated media (covers, inline images)
  comments  Comment[]
  purchases Purchase[]
  communityNotes CommunityNote[]
  
  @@index([slug])
  @@index([authorId])
  @@index([status])
  @@index([isExclusive])
  @@index([createdAt])
  @@index([publishedAt])
  @@index([likeCount])
  @@index([viewCount])
  @@map("blogs")
}

// =========================================
// TAG MODEL
// =========================================
model Tag {
  id        String    @id @default(cuid())
  name      String    @unique
  slug      String    @unique
  blogCount Int       @default(0)
  createdAt DateTime  @default(now())
  
  blogs     BlogTag[]
  
  @@index([slug])
  @@index([blogCount])
  @@map("tags")
}

// =========================================
// BLOG-TAG RELATION (Many-to-Many)
// =========================================
model BlogTag {
  id        String   @id @default(cuid())
  blogId    String
  tagId     String
  createdAt DateTime @default(now())
  
  blog      Blog     @relation(fields: [blogId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([blogId, tagId])
  @@index([blogId])
  @@index([tagId])
  @@map("blog_tags")
}

// =========================================
// LIKE MODEL
// =========================================
model Like {
  id        String   @id @default(cuid())
  userId    String
  blogId    String
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  blog      Blog     @relation(fields: [blogId], references: [id], onDelete: Cascade)
  
  @@unique([userId, blogId])
  @@index([userId])
  @@index([blogId])
  @@map("likes")
}

// =========================================
// BOOKMARK MODEL
// =========================================
model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  blogId    String
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  blog      Blog     @relation(fields: [blogId], references: [id], onDelete: Cascade)
  
  @@unique([userId, blogId])
  @@index([userId])
  @@index([blogId])
  @@map("bookmarks")
}

// =========================================
// MEDIA MODEL (File Uploads)
// =========================================
model Media {
  id          String       @id @default(cuid())
  userId      String
  
  // File info
  filename    String       // Original filename
  key         String       @unique // S3/R2 key (path in bucket)
  url         String       // Public URL
  mimeType    String
  size        Int          // File size in bytes
  type        MediaType    // File category
  purpose     MediaPurpose @default(GENERAL) // Usage purpose
  
  // Association with blog (optional)
  blogId      String?
  blog        Blog?        @relation(fields: [blogId], references: [id], onDelete: SetNull)
  
  // Metadata
  alt         String?      // Alt text for images
  width       Int?         // Image width
  height      Int?         // Image height
  
  // Timestamps
  createdAt   DateTime     @default(now())
  deletedAt   DateTime?    // Soft delete
  
  @@index([userId])
  @@index([blogId])
  @@index([type])
  @@index([purpose])
  @@index([createdAt])
  @@map("media")
}

// =========================================
// ENUMS
// =========================================
enum Role {
  USER      // Regular reader
  CREATOR   // Can publish blogs
  ADMIN     // Platform admin
  OWNER     // Platform owner (you)
}

enum BlogStatus {
  DRAFT     // Not visible to anyone except author
  PUBLISHED // Visible to public (or purchasers if exclusive)
  ARCHIVED  // Hidden but not deleted
}

enum MediaType {
  IMAGE     // Blog images, avatars, covers
  DOCUMENT  // PDFs, etc.
  OTHER
}

enum MediaPurpose {
  AVATAR    // User profile picture
  COVER     // Blog cover image
  INLINE    // Image within blog content
  GENERAL   // Unassigned / media library
}

// =========================================
// COMMENT MODEL
// =========================================
model Comment {
  id          String    @id @default(cuid())
  content     String    @db.Text
  userId      String
  blogId      String
  
  // Threading / Replies
  parentId    String?
  parent      Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Comment[] @relation("CommentReplies")
  
  // Counters
  likeCount   Int       @default(0)
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  
  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  blog        Blog      @relation(fields: [blogId], references: [id], onDelete: Cascade)
  likes       CommentLike[]
  
  @@index([userId])
  @@index([blogId])
  @@index([parentId])
  @@index([createdAt])
  @@map("comments")
}

// =========================================
// COMMENT LIKE MODEL
// =========================================
model CommentLike {
  id        String   @id @default(cuid())
  userId    String
  commentId String
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  
  @@unique([userId, commentId])
  @@index([userId])
  @@index([commentId])
  @@map("comment_likes")
}

// =========================================
// PURCHASE MODEL (Razorpay Payments)
// =========================================
model Purchase {
  id        String   @id @default(cuid())
  userId    String
  blogId    String
  amount    Int      // Amount paid in paise (INR)
  currency  String   @default("INR")
  
  // Razorpay Info
  paymentId String?  // Razorpay Payment ID
  orderId   String   @unique // Razorpay Order ID
  signature String?  // Razorpay Signature
  status    PaymentStatus @default(PENDING)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  blog      Blog     @relation(fields: [blogId], references: [id], onDelete: Cascade)
  
  @@unique([userId, blogId]) // Unlock once
  @@index([userId])
  @@index([blogId])
  @@map("purchases")
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// =========================================
// WALLET & LEDGER SYSTEM
// =========================================
model Wallet {
  id        String   @id @default(cuid())
  userId    String   @unique
  balance   Int      @default(0) // Current balance in tokens
  updatedAt DateTime @updatedAt
  
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@map("wallets")
}

model Transaction {
  id        String          @id @default(cuid())
  walletId  String
  amount    Int             // Positive for credit, negative for debit
  type      TransactionType
  status    PaymentStatus   @default(COMPLETED)
  referenceId String?       // ID of related entity (purchaseId, payoutId)
  metadata  Json?           // Extra details { blogId: ..., fromUserId: ... }
  createdAt DateTime        @default(now())

  wallet    Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([type])
  @@index([createdAt])
  @@map("transactions")
}

enum TransactionType {
  DEPOSIT       // User buys tokens (Real Money -> Tokens)
  SPEND         // User unlocks content (Tokens -> System)
  EARNING       // Creator receives share (System -> Tokens)
  WITHDRAWAL    // Creator converts tokens (Tokens -> Real Money)
  PLATFORM_FEE  // Platform share
  REFUND        // Refund
}

// =========================================
// COMMUNITY NOTES (Crowd Wisdom)
// =========================================
model CommunityNote {
  id        String     @id @default(cuid())
  blogId    String
  userId    String
  content   String     @db.Text
  quote     String?    @db.Text // Selected text context
  status    NoteStatus @default(PENDING)
  
  // Voting stats
  helpfulCount    Int @default(0)
  notHelpfulCount Int @default(0)
  score           Int @default(0) // helpful - notHelpful

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  blog      Blog     @relation(fields: [blogId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  votes     NoteVote[]

  @@index([blogId])
  @@index([status])
  @@map("community_notes")
}

model NoteVote {
  id        String   @id @default(cuid())
  userId    String
  noteId    String
  isHelpful Boolean
  createdAt DateTime @default(now())

  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  note      CommunityNote @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@unique([userId, noteId])
  @@map("note_votes")
}

enum NoteStatus {
  PENDING
  PUBLISHED // Visible context added
  REJECTED  // Not helpful
}

// =========================================
// NOTIFICATION MODEL
// =========================================
model Notification {
  id        String   @id @default(cuid())
  userId    String   // Recipient
  type      NotificationType
  title     String
  message   String
  data      Json?    // Flexible JSON for linking (e.g. { blogId: '...', actorId: '...' })
  isRead    Boolean  @default(false)
  
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

enum NotificationType {
  LIKE      // Someone liked your blog/comment
  COMMENT   // Someone commented on your blog
  REPLY     // Someone replied to your comment
  FOLLOW    // Someone followed you
  MENTION   // Someone mentioned you
  PURCHASE  // Someone bought your blog
  SYSTEM    // Admin/Platform alerts
}
